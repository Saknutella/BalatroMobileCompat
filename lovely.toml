[manifest]
version = "1.0.0"
dump_lua = true
priority = 0

# 修复触摸输入
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = 'if G.CONTROLLER.text_input_hook == e and G.CONTROLLER.HID.controller then'
position = "at"
payload = 'if G.CONTROLLER.text_input_hook == e and (G.CONTROLLER.HID.controller or G.CONTROLLER.HID.touch) then'
match_indent = true

# 修复 flame shader 精度问题
[[patches]]
[patches.pattern]
target = "game.lua"
pattern = 'self.SHADERS[shader_name] = love.graphics.newShader("resources/shaders/"..filename)'
position = "before"
payload = '''
if shader_name ==  "flame" then
	local code =
	love.filesystem.read("resources/shaders/"..filename)
	:gsub("#endif", "#endif\n#ifdef GL_ES\n\tprecision MY_HIGHP_OR_MEDIUMP float;\n#endif", 1)
	:gsub("vec4 effect%( vec4 colour, Image texture, vec2 texture_coords, vec2 screen_coords %)", "mediump vec4 effect%( mediump vec4 colour, Image texture, mediump vec2 texture_coords, mediump vec2 screen_coords %)", 1)
	print(code)
	G.SHADERS[shader_name] =  love.graphics.newShader(code)
else
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "game.lua"
pattern = 'self.SHADERS[shader_name] = love.graphics.newShader("resources/shaders/"..filename)'
position = "after"
payload = '''
end
'''
match_indent = true

# 动态控制 CRT shader - 根据全局变量决定是否应用
[[patches]]
[patches.pattern]
target = "game.lua"
pattern = "love.graphics.setShader( G.SHADERS['CRT'])"
position = "at"
payload = "if G.BMC_CRT_ENABLED then love.graphics.setShader(G.SHADERS['CRT']) end"
match_indent = true

# 动态 FPS 限制 - 根据全局变量决定 FPS 上限
[[patches]]
[patches.pattern]
target = "main.lua"
pattern = 'G.FPS_CAP = G.FPS_CAP or 500'
position = "at"
payload = "G.FPS_CAP = G.FPS_CAP or (G.BMC_FPS_LIMIT_ENABLED and select(3, love.window.getMode())['refreshrate'] or 500)"
match_indent = true

# 外部存储和 DPI 设置
[[patches]]
[patches.pattern]
target = "conf.lua"
pattern = 't.window.minheight = 100'
position = "after"
payload = '''
t.externalstorage = true
t.window.usedpiscale = false
'''
match_indent = true

# 高 DPI 支持
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = "highdpi = (love.system.getOS() == 'OS X')"
position = "at"
payload = "highdpi = (love.system.getOS() == 'OS X' or love.system.getOS() == 'Android' or love.system.getOS() == 'iOS')"
match_indent = true

# 窗口可调整大小
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = 'resizable = true,'
position = "at"
payload = "resizable = not (love.system.getOS() == 'Android' or love.system.getOS() == 'iOS'),"
match_indent = true
