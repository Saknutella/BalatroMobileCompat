[manifest]
version = "1.0.0"
dump_lua = true
priority = 0
-- use controller
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = 'if G.CONTROLLER.text_input_hook == e and G.CONTROLLER.HID.controller then'
position = "at"
payload = 'if G.CONTROLLER.text_input_hook == e and (G.CONTROLLER.HID.controller or G.CONTROLLER.HID.touch) then'
match_indent = true
-- set displays
[[patches]]
[patches.pattern]
target = "globals.lua" 
pattern = '--loadstring("\105\102\32\108\111\118\101\46\115\121\115\116\101\109\46\103\101\116\79\83\40\41\32\61\61\32\39\105\79\83\39\32\111\114\32\108\111\118\101\46\115\121\115\116\101\109\46\103\101\116\79\83\40\41\32\61\61\32\39\65\110\100\114\111\105\100\39\32\116\104\101\110\10\32\32\108\111\118\101\46\101\118\101\110\116\46\113\117\105\116\40\41\10\101\110\100\10")()'
position = "at"
payload = '''
-- Removed 'loadstring' line which generated lua code that exited upon starting on mobile
if love.system.getOS() == 'Android' or love.system.getOS() == 'iOS' then
	self.F_SAVE_TIMER = 5
	self.F_DISCORD = true
	self.F_NO_ACHIEVEMENTS = true
	self.F_CRASH_REPORTS = false
	self.F_SOUND_THREAD = true
	self.F_VIDEO_SETTINGS = false
	self.F_ENGLISH_ONLY = false
	self.F_QUIT_BUTTON = false
	self.F_MOBILE_UI = true
end'''
match_indent = true

[[patches]]
[patches.pattern]
target = "conf.lua"
pattern = 't.window.minheight = 100'
position = "after"
payload = '''
t.externalstorage = true
t.window.usedpiscale = false
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "main.lua"
pattern = 'G.FPS_CAP = G.FPS_CAP or 500'
position = "at"
payload = "G.FPS_CAP = G.FPS_CAP or select(3, love.window.getMode())['refreshrate']"
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = "highdpi = (love.system.getOS() == 'OS X')"
position = "at"
payload = "highdpi = (love.system.getOS() == 'OS X' or love.system.getOS() == 'Android' or love.system.getOS() == 'iOS')"
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = 'resizable = true,'
position = "at"
payload = "resizable = not (love.system.getOS() == 'Android' or love.system.getOS() == 'iOS'),"
match_indent = true

[[patches]]
[patches.pattern]
target = "game.lua"
pattern = 'self.SHADERS[shader_name] = love.graphics.newShader("resources/shaders/"..filename)'
position = "before"
payload = '''
if shader_name ==  "flame" then
	local code =
	love.filesystem.read("resources/shaders/"..filename)
	:gsub("#endif", "#endif\n#ifdef GL_ES\n\tprecision MY_HIGHP_OR_MEDIUMP float;\n#endif", 1)
	:gsub("vec4 effect%( vec4 colour, Image texture, vec2 texture_coords, vec2 screen_coords %)", "mediump vec4 effect%( mediump vec4 colour, Image texture, mediump vec2 texture_coords, mediump vec2 screen_coords %)", 1)
	print(code)
	G.SHADERS[shader_name] =  love.graphics.newShader(code)
else
'''
match_indent = true


[[patches]]
[patches.pattern]
target = "game.lua"
pattern = 'self.SHADERS[shader_name] = love.graphics.newShader("resources/shaders/"..filename)'
position = "after"
payload = '''
end
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = '{n=G.UIT.C, config={align = "cm", minh = 0.7, minw = 0.9, padding = 0.1, r = 0.1, hover = true, colour =G.C.ORANGE, button = "sort_hand_value", shadow = true}, nodes={'
position = "at"
payload = '{n=G.UIT.C, config={align = "cm", minh = 0.8, minw = 1.3, padding = 0.1, r = 0.1, hover = true, colour =G.C.ORANGE, button = "sort_hand_value", shadow = true}, nodes={'
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = '{n=G.UIT.C, config={align = "cm", minh = 0.7, minw = 0.9, padding = 0.1, r = 0.1, hover = true, colour =G.C.ORANGE, button = "sort_hand_suit", shadow = true}, nodes={'
position = "at"
payload = '{n=G.UIT.C, config={align = "cm", minh = 0.8, minw = 1.3, padding = 0.1, r = 0.1, hover = true, colour =G.C.ORANGE, button = "sort_hand_suit", shadow = true}, nodes={'
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "not run_info and {n=G.UIT.R, config={id = 'select_blind_button', align = \"cm\", ref_table = blind_choice.config, colour = disabled and G.C.UI.BACKGROUND_INACTIVE or G.C.ORANGE, minh = 0.6, minw = 2.7, padding = 0.07, r = 0.1, shadow = true, hover = true, one_press = true, button = 'select_blind'}, nodes={"
position = "at"
payload = "not run_info and {n=G.UIT.R, config={id = 'select_blind_button', align = \"cm\", ref_table = blind_choice.config, colour = disabled and G.C.UI.BACKGROUND_INACTIVE or G.C.ORANGE, minh = 1.2, minw = 2.7, padding = 0.07, r = 0.1, shadow = true, hover = true, one_press = true, button = 'select_blind'}, nodes={"
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "{n=G.UIT.T, config={text = localize(blind_state, 'blind_states'), scale = 0.45, colour = G.C.UI.TEXT_LIGHT, shadow = true}}"
position = "at"
payload = "{n=G.UIT.T, config={text = localize(blind_state, 'blind_states'), scale = 0.65, colour = G.C.UI.TEXT_LIGHT, shadow = true}}"
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "{n=G.UIT.C, config={align = \"cm\",r = 0.1, minw = 0.6*args.scale, hover = not disabled, colour = not disabled and args.colour or G.C.BLACK,shadow = not disabled, button = not disabled and 'option_cycle' or nil, ref_table = args, ref_value = 'l', focus_args = {type = 'none'}}, nodes={"
position = "at"
payload = "{n=G.UIT.C, config={align = \"cm\",r = 0.1, minw = 1.2*args.scale, hover = not disabled, colour = not disabled and args.colour or G.C.BLACK,shadow = not disabled, button = not disabled and 'option_cycle' or nil, ref_table = args, ref_value = 'l', focus_args = {type = 'none'}}, nodes={"
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = "{n=G.UIT.C, config={align = \"cm\",r = 0.1, minw = 0.6*args.scale, hover = not disabled, colour = not disabled and args.colour or G.C.BLACK,shadow = not disabled, button = not disabled and 'option_cycle' or nil, ref_table = args, ref_value = 'r', focus_args = {type = 'none'}}, nodes={"
position = "at"
payload = "{n=G.UIT.C, config={align = \"cm\",r = 0.1, minw = 1.2*args.scale, hover = not disabled, colour = not disabled and args.colour or G.C.BLACK,shadow = not disabled, button = not disabled and 'option_cycle' or nil, ref_table = args, ref_value = 'r', focus_args = {type = 'none'}}, nodes={"
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = '''
function create_keyboard_button(key, binding)
  local key_label = (key == 'backspace' and 'Backspace') or (key == ' ' and 'Space') or (key == 'back' and 'Back') or (key == 'return' and 'Enter') or key
  return UIBox_button{ label = {key_label}, button = "key_button", ref_table = {key = key == 'back' and 'return' or key},
      minw = key == ' ' and 6 or key == 'return' and 2.5 or key == 'backspace' and 2.5 or key == 'back' and 2.5 or 0.8,
      minh = key == 'return' and 1.5 or key == 'backspace' and 1.5 or key == 'back' and 0.8 or 0.7,
      col = true, colour = G.C.GREY, focus_args = binding and {button = binding, orientation = (key == ' ' or key == 'back') and 'cr' or 'bm', set_button_pip= true} or nil}
end
'''
position = "at"
payload = '''
function create_keyboard_button(key, binding)
  local overall_scale = 1.9
  local key_label = (key == 'backspace' and 'Backspace') or (key == ' ' and 'Space') or (key == 'back' and 'Back') or (key == 'return' and 'Enter') or key
  return UIBox_button{ label = {key_label}, scale = overall_scale*0.5, button = "key_button", ref_table = {key = key == 'back' and 'return' or key},
      minw = key == ' ' and overall_scale*6 or key == 'return' and overall_scale*2.5 or key == 'backspace' and overall_scale*2.5 or key == 'back' and overall_scale*2.5 or overall_scale*0.8,
      minh = key == 'return' and 1.5 or key == 'backspace' and 1.5 or key == 'back' and 0.8 or overall_scale*0.7,
      col = true, colour = G.C.GREY, focus_args = binding and {button = binding, orientation = (key == ' ' or key == 'back') and 'cr' or 'bm', set_button_pip= true} or nil}
end'''
match_indent = true
times = 1



